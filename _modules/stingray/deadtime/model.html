<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stingray.deadtime.model &#8212; stingray v</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=2afd17ea" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/stingray_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Sting</span><span id="logotext2">ray</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">stingray v</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for stingray.deadtime.model</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">stingray.utils</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>

<span class="kn">from</span> <span class="nn">stingray.loggingconfig</span> <span class="kn">import</span> <span class="n">setup_logger</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">factorial</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">()</span>

<span class="n">MAX_FACTORIAL</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">__INVERSE_FACTORIALS</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">MAX_FACTORIAL</span><span class="p">))</span>
<span class="n">PRECISION</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">precision</span>
<span class="n">TWOPI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">STERLING_PARAMETERS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">288</span><span class="p">,</span> <span class="o">-</span><span class="mi">139</span> <span class="o">/</span> <span class="mi">51840</span><span class="p">,</span> <span class="o">-</span><span class="mi">571</span> <span class="o">/</span> <span class="mi">2488320</span><span class="p">])</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;r_det&quot;</span><span class="p">,</span>
    <span class="s2">&quot;r_in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pds_model_zhang&quot;</span><span class="p">,</span>
    <span class="s2">&quot;non_paralyzable_dead_time_model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;check_A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;check_B&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_stirling_factor</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First few terms of series expansion appearing in Stirling&#39;s approximation.&quot;&quot;&quot;</span>
    <span class="n">fact</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">power</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">power</span> <span class="o">*=</span> <span class="n">m</span>
        <span class="n">fact</span> <span class="o">+=</span> <span class="n">STERLING_PARAMETERS</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">power</span>
    <span class="k">return</span> <span class="n">fact</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">e_m_x_x_over_factorial</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Approximate the large number ratio in Eq. 34.</span>

<span class="sd">    The original formula for :math:`G_n` (eq. 34 in Zhang+95) has factors of the kind</span>
<span class="sd">    :math:`e^{-x} x^l / l!`. This is the product of very large numbers, that mostly</span>
<span class="sd">    balance each other. In this function, we approximate this product for large :math:`l`</span>
<span class="sd">    starting from Stirling&#39;s approximation for the factorial:</span>

<span class="sd">    .. math::</span>

<span class="sd">       l! \approx \sqrt{2\pi l} (\frac{l}{e})^l A(l)</span>

<span class="sd">    where :math:`A(l)` is a series expansion in 1/l of the form</span>
<span class="sd">    :math:`1 + 1 / 12l + 1 / 288l^2 - 139/51840/l^3 + ...`. This allows to transform the product</span>
<span class="sd">    above into</span>

<span class="sd">    .. math::</span>

<span class="sd">       \frac{e^{-x} x^l}{l!} \approx \frac{1}{A(l)\sqrt{2\pi l}}\left(\frac{x e}{l}\right)^l e^{-x}</span>

<span class="sd">    and then, bringing the exponential into the parenthesis</span>

<span class="sd">    .. math::</span>

<span class="sd">       \frac{e^{-x} x^l}{l!}\approx\frac{1}{A(l)\sqrt{2\pi l}} \left(\frac{x e^{1-x/l}}{l}\right)^l</span>

<span class="sd">    The function inside the brackets has a maximum around :math:`x \approx l` and is well-behaved,</span>
<span class="sd">    allowing to approximate the product for large :math:`l` without the need to calculate the</span>
<span class="sd">    factorial or the exponentials directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Numerical errors occur when x is not a float</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="c1"># For decently small numbers, use the direct formula</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="n">m</span> <span class="o">*</span> <span class="n">__INVERSE_FACTORIALS</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

    <span class="c1"># Use Stirling&#39;s approximation</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">TWOPI</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">_stirling_factor</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>


<div class="viewcode-block" id="r_in">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.r_in">[docs]</a>
<span class="k">def</span> <span class="nf">r_in</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">r_0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate incident countrate given dead time and detected countrate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    r_0 : float</span>
<span class="sd">        Detected countrate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r_0</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span> <span class="o">-</span> <span class="n">td</span><span class="p">)</span></div>



<div class="viewcode-block" id="r_det">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.r_det">[docs]</a>
<span class="k">def</span> <span class="nf">r_det</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">r_i</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate detected countrate given dead time and incident countrate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    r_i : float</span>
<span class="sd">        Incident countrate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r_i</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="n">td</span><span class="p">)</span></div>



<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_Gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 34 in Zhang+95.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">e_m_x_x_over_factorial</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="n">new_val</span>
        <span class="c1"># The curve above has a maximum around x~l</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="ow">and</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_val</span> <span class="o">/</span> <span class="n">s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">PRECISION</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">s</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_h</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 35 in Zhang+95.&quot;&quot;&quot;</span>
    <span class="c1"># Typo in Zhang+95 corrected. k * tb, not k * td</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">td</span>

    <span class="k">if</span> <span class="n">k</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">td</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">val</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">td</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">/</span> <span class="n">tb</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">/</span> <span class="n">tb</span> <span class="o">*</span> <span class="n">_Gn</span><span class="p">(</span><span class="n">factor</span> <span class="o">/</span> <span class="n">tau</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">val</span>


<span class="n">INFINITE</span> <span class="o">=</span> <span class="mi">699</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">A0</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 38 in Zhang+95.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r0 : float</span>
<span class="sd">        Detected countrate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    tau : float</span>
<span class="sd">        Inverse of the incident countrate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">tb</span> <span class="o">/</span> <span class="n">td</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">_h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">A_single_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 39 in Zhang+95.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int</span>
<span class="sd">        Order of the term</span>
<span class="sd">    r0 : float</span>
<span class="sd">        Detected countrate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    tau : float</span>
<span class="sd">        Inverse of the incident countrate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">A0</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
    <span class="c1"># Equation 39</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">/</span> <span class="n">td</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))):</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">_h</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_h</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="n">_h</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="n">new_val</span>

    <span class="k">return</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">*</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">A</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 39 in Zhang+95.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int or array of ints</span>
<span class="sd">        Order of the term</span>
<span class="sd">    r0 : float</span>
<span class="sd">        Detected countrate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    tau : float</span>
<span class="sd">        Inverse of the incident countrate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A_single_k</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">A_single_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">limit_A</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Limit of A for k-&gt;infty, as per Eq. 43 in Zhang+95.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rate : float</span>
<span class="sd">        Incident count rate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">r_det</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tb</span><span class="o">**</span><span class="mi">2</span>


<div class="viewcode-block" id="check_A">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.check_A">[docs]</a>
<span class="k">def</span> <span class="nf">check_A</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">max_k</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">save_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span> <span class="n">rate_is_incident</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test that A is well-behaved.</span>

<span class="sd">    This function produces a plot of :math:`A_k - r_0^2 t_b^2` vs :math:`k`, to visually check that</span>
<span class="sd">    :math:`A_k \rightarrow r_0^2 t_b^2` for :math:`k\rightarrow\infty`, as per Eq. 43 in Zhang+95.</span>

<span class="sd">    With this function is possible to determine how many inner loops `k` (`limit_k` in function</span>
<span class="sd">    pds_model_zhang) are necessary for a correct approximation of the dead time model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rate : float</span>
<span class="sd">        Count rate, either incident or detected (use the `rate_is_incident` bool to specify)</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    max_k : int</span>
<span class="sd">        Maximum k to plot</span>
<span class="sd">    save_to : str, default None</span>
<span class="sd">        If not None, save the plot to this file</span>
<span class="sd">    linthresh : float, default 0.000001</span>
<span class="sd">        Linear threshold for the &quot;symlog&quot; scale of the plot</span>
<span class="sd">    rate_is_incident : bool, default True</span>
<span class="sd">        If True, the input rate is the incident count rate. If False, it is the detected one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rate_is_incident</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">r_det</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">rate</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r_in</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>

    <span class="n">limit</span> <span class="o">=</span> <span class="n">limit_A</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">k_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">A_values</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="n">A_values</span> <span class="o">-</span> <span class="n">limit</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;symlog&quot;</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$k$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$A_k - r_0^2 t_b^2$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_to</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k_values</span><span class="p">,</span> <span class="n">A_values</span></div>



<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_B_raw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 45 in Zhang+95.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">A_single_k</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">-</span> <span class="n">r0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r0</span> <span class="o">*</span> <span class="n">tb</span><span class="p">)</span>

    <span class="n">new_val</span> <span class="o">=</span> <span class="n">A_single_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">-</span> <span class="n">r0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tb</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">new_val</span> <span class="o">/</span> <span class="p">(</span><span class="n">r0</span> <span class="o">*</span> <span class="n">tb</span><span class="p">)</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_safe_B_single_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 39 in Zhang+95, with a cut in the maximum k.</span>

<span class="sd">    This can be risky. Only use if B is really 0 for high k.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">limit_k</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">_B_raw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_safe_B</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 39 in Zhang+95, with a cut in the maximum k.</span>

<span class="sd">    This can be risky. Only use if B is really 0 for high k.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_safe_B_single_k</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">)</span> <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_safe_B_single_k</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">B</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Term in Eq. 39 in Zhang+95, with a cut in the maximum k.</span>

<span class="sd">    The cut can be risky. Only use if B is really 0 for high k. Use `check_B` to test.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int or array of ints</span>
<span class="sd">        Order of the term</span>
<span class="sd">    r0 : float</span>
<span class="sd">        Detected countrate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    tau : float</span>
<span class="sd">        Inverse of the incident countrate</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    limit_k : int</span>
<span class="sd">        Limit to this value the number of terms in the inner loops of</span>
<span class="sd">        calculations. Check the plots returned by  the `check_B` and</span>
<span class="sd">        `check_A` functions to test that this number is adequate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_safe_B</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">)</span>


<div class="viewcode-block" id="check_B">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.check_B">[docs]</a>
<span class="k">def</span> <span class="nf">check_B</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">max_k</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">save_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span> <span class="n">rate_is_incident</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check that :math:`B\rightarrow 0` for :math:`k\rightarrow \infty`.</span>

<span class="sd">    This function produces a plot of :math:`B_k` vs :math:`k`, to visually check that</span>
<span class="sd">    :math:`B_k \rightarrow 0` for :math:`k\rightarrow\infty`, as per Eq. 43 in Zhang+95.</span>

<span class="sd">    With this function is possible to determine how many inner loops `k` (`limit_k` in function</span>
<span class="sd">    pds_model_zhang) are necessary for a correct approximation of the dead time model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rate : float</span>
<span class="sd">        Count rate, either incident or detected (use the `rate_is_incident` bool to specify)</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    max_k : int</span>
<span class="sd">        Maximum k to plot</span>
<span class="sd">    save_to : str, default None</span>
<span class="sd">        If not None, save the plot to this file</span>
<span class="sd">    linthresh : float, default 0.000001</span>
<span class="sd">        Linear threshold for the &quot;symlog&quot; scale of the plot</span>
<span class="sd">    rate_is_incident : bool, default True</span>
<span class="sd">        If True, the input rate is the incident count rate. If False, it is the detected one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rate_is_incident</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">r_det</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">rate</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r_in</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">k_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">B_values</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">max_k</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tb</span> <span class="o">/</span> <span class="n">td</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Est. propagation of float errors&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="o">-</span><span class="n">threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_values</span><span class="p">,</span> <span class="n">B_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="s2">&quot;steps-mid&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;symlog&quot;</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$k$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$B_k$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_k</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_to</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k_values</span><span class="p">,</span> <span class="n">B_values</span></div>



<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_inner_loop_pds_zhang</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the power spectrum, as per Eq. 44 in Zhang+95.&quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">eq8_sum</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">limit_k</span><span class="p">)):</span>
            <span class="n">Bk</span> <span class="o">=</span> <span class="n">_safe_B_single_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">)</span>

            <span class="n">eq8_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">*</span> <span class="n">Bk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>

        <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_safe_B_single_k</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="n">eq8_sum</span>

    <span class="k">return</span> <span class="n">P</span>


<div class="viewcode-block" id="pds_model_zhang">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.pds_model_zhang">[docs]</a>
<span class="k">def</span> <span class="nf">pds_model_zhang</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">rate_is_incident</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the dead-time-modified power spectrum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        The number of spectral bins</span>
<span class="sd">    rate : float</span>
<span class="sd">        Incident count rate</span>
<span class="sd">    td : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    tb : float</span>
<span class="sd">        Bin time of the light curve</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    limit_k : int</span>
<span class="sd">        Limit to this value the number of terms in the inner loops of</span>
<span class="sd">        calculations. Check the plots returned by  the `check_B` and</span>
<span class="sd">        `check_A` functions to test that this number is adequate.</span>
<span class="sd">    rate_is_incident : bool, default True</span>
<span class="sd">        If True, the input rate is the incident count rate. If False, it is the</span>
<span class="sd">        detected count rate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    freqs : array of floats</span>
<span class="sd">        Frequency array</span>
<span class="sd">    power : array of floats</span>
<span class="sd">        Power spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rate_is_incident</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">r_det</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">rate</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r_in</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>

    <span class="c1"># Nph = N / tau</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating PDS model (update)&quot;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">_inner_loop_pds_zhang</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tb</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">td</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The bin time is much larger than the dead time. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Calculations might be slow. tb=</span><span class="si">{</span><span class="n">tb</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">td</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> * td&quot;</span>
        <span class="p">)</span>

    <span class="n">maxf</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">tb</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">maxf</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">))</span> <span class="o">*</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">P</span></div>



<div class="viewcode-block" id="non_paralyzable_dead_time_model">
<a class="viewcode-back" href="../../../api.html#stingray.deadtime.model.non_paralyzable_dead_time_model">[docs]</a>
<span class="k">def</span> <span class="nf">non_paralyzable_dead_time_model</span><span class="p">(</span>
    <span class="n">freqs</span><span class="p">,</span>
    <span class="n">dead_time</span><span class="p">,</span>
    <span class="n">rate</span><span class="p">,</span>
    <span class="n">bin_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_k</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">background_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">n_approx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the dead-time-modified power spectrum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    freqs : array of floats</span>
<span class="sd">        Frequency array</span>
<span class="sd">    dead_time : float</span>
<span class="sd">        Dead time</span>
<span class="sd">    rate : float</span>
<span class="sd">        Detected source count rate</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    bin_time : float</span>
<span class="sd">        Bin time of the light curve</span>
<span class="sd">    limit_k : int, default 200</span>
<span class="sd">        Limit to this value the number of terms in the inner loops of</span>
<span class="sd">        calculations. Check the plots returned by  the `check_B` and</span>
<span class="sd">        `check_A` functions to test that this number is adequate.</span>
<span class="sd">    background_rate : float, default 0</span>
<span class="sd">        Detected background count rate. This is important to estimate when deadtime is given by the</span>
<span class="sd">        combination of the source counts and background counts (e.g. in an imaging X-ray detector).</span>
<span class="sd">    n_approx : int, default None</span>
<span class="sd">        Number of bins to calculate the model power spectrum. If None, it will use the size of</span>
<span class="sd">        the input frequency array. Relatively simple models (e.g., low count rates compared to</span>
<span class="sd">        dead time) can use a smaller number of bins to speed up the calculation, and the final</span>
<span class="sd">        power values will be interpolated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    power : array of floats</span>
<span class="sd">        Power spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rate</span> <span class="o">+</span> <span class="n">background_rate</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dead_time</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The sum of the source and background count rates is larger than the inverse &quot;</span>
            <span class="s2">&quot;of the dead time. This is not a physical situation. Please check your input.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">bin_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bin_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">))</span>

    <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_approx</span> <span class="k">if</span> <span class="n">n_approx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">zh_f</span><span class="p">,</span> <span class="n">zh_p</span> <span class="o">=</span> <span class="n">pds_model_zhang</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">(</span><span class="n">rate</span> <span class="o">+</span> <span class="n">background_rate</span><span class="p">),</span>
        <span class="n">dead_time</span><span class="p">,</span>
        <span class="n">bin_time</span><span class="p">,</span>
        <span class="n">limit_k</span><span class="o">=</span><span class="n">limit_k</span><span class="p">,</span>
        <span class="n">rate_is_incident</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Rescale by the source rate wrt background rate</span>
    <span class="k">if</span> <span class="n">background_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zh_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">zh_p</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">rate</span> <span class="o">+</span> <span class="n">background_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="n">pds_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">zh_f</span><span class="p">,</span> <span class="n">zh_p</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pds_interp</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2024, [{&#39;name&#39;: &#39;Stingray Developers&#39;, &#39;email&#39;: &#39;spectraltiming-stingray@googlegroups.com&#39;}].<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 8.0.2. &nbsp;
    Last built 09 Oct 2024. <br/>
  </p>
</footer>
  </body>
</html>